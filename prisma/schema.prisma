generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum Role {
  USER
  SELLER
  MODERATOR
  ADMIN
}

enum AuctionStatus {
  DRAFT
  SCHEDULED
  ACTIVE
  PAUSED
  COMPLETED
  PENDING_PAYMENT
  FAILED_PAYMENT
  FALLBACK_IN_PROGRESS
  PUBLIC_FALLBACK
  SOLD
  FAILED
  CANCELLED
}

enum OtpPurpose {
  REGISTER
  LOGIN
  VERIFY_PHONE
  VERIFY_EMAIL
  RESET_PASSWORD
}

enum OtpChannel {
  SMS
  EMAIL
}

enum OtpStatus {
  PENDING
  VERIFIED
  EXPIRED
  BLOCKED
}

enum FlagSource {
  SYSTEM
  MODERATOR
  ADMIN
}

// USER & ACCESS CONTROL
model User {
  user_id       String   @id @default(uuid())
  name          String
  email         String   @unique
  phone         String   @unique
  address       String
  avatar_url    String?
  password_hash String
  is_active     Boolean  @default(true)
  is_blocked    Boolean  @default(false)
  is_verified   Boolean  @default(false)
  assigned_at   DateTime @default(now())
  created_at    DateTime @default(now())

  // Relationships
  UserRole           UserRole[]
  UserSession        UserSession[]
  KYCProfile         KYCProfile[]
  Wallet             Wallet?
  OTPVerification    OTPVerification[]
  SoldAuctions       Auction[]           @relation("SellerAuctions")
  ModeratorRoles     AuctionModerator[]  @relation("ModeratorRelation")
  ModeratorActions   ModeratorAction[]   @relation("ModeratorActions")
  Bids               Bid[]
  LetterBidCommits   LetterBidCommit[]
  UserSubscriptions  UserSubscription[]
  AIAgentProfile     AIAgentProfile?
  AutoBidRules       AutoBidRule[]
  WonAuctions        AuctionResult[]     @relation("WinnerRelation")
  Deposits           AuctionDeposit[]
  FallbackOffers     FallbackOffer[]
  FraudFlags         FraudFlag[]
  RaisedDisputes     Dispute[]           @relation("DisputeRaiser")
  AccusedDisputes    Dispute[]           @relation("DisputeAccused")
  Notifications      Notification[]
  AdminActions       AdminAction[]       @relation("AdminRelation")
  AuditLogs          SystemAuditLog[]
  AuctionConnections AuctionConnection[]
}

model UserRole {
  user_role_id String   @id @default(uuid())
  user_id      String
  role         Role
  assigned_at  DateTime @default(now())

  User User @relation(fields: [user_id], references: [user_id])
}

model UserSession {
  session_id    String   @id @default(uuid())
  user_id       String
  refresh_token String
  device_info   String?
  ip_address    String?
  expires_at    DateTime @default(now())

  User User @relation(fields: [user_id], references: [user_id])
}

model OTPVerification {
  otp_id       String     @id @default(uuid())
  user_id      String
  identifier   String
  otp_hash     String
  purpose      OtpPurpose
  channel      OtpChannel
  expires_at   DateTime
  attempts     Int        @default(0)
  max_attempts Int        @default(3)
  status       OtpStatus  @default(PENDING)
  created_at   DateTime   @default(now())

  User User @relation(fields: [user_id], references: [user_id])
}

// KYC & VERIFICATION
model KYCProfile {
  kyc_id              String   @id @default(uuid())
  user_id             String
  document_type       String
  document_number     String
  address             String?
  verification_status String
  id_front_url        String?
  id_back_url         String?
  address_proof_url   String?
  updated_at          DateTime @updatedAt

  User User @relation(fields: [user_id], references: [user_id])
}

// WALLET & FINANCIAL LEDGER
model Wallet {
  wallet_id      String   @id @default(uuid())
  user_id        String   @unique
  balance        Decimal  @default(0)
  locked_balance Decimal  @default(0)
  updated_at     DateTime @updatedAt

  User               User                @relation(fields: [user_id], references: [user_id])
  WalletTransactions WalletTransaction[]
}

model WalletTransaction {
  transaction_id   String   @id @default(uuid())
  wallet_id        String
  auction_id       String?
  amount           Decimal
  transaction_type String
  status           String
  created_at       DateTime @default(now())

  Wallet  Wallet   @relation(fields: [wallet_id], references: [wallet_id])
  Auction Auction? @relation(fields: [auction_id], references: [auction_id])
}

// AUCTIONS (CORE)
model Auction {
  auction_id               String        @id @default(uuid())
  seller_id                String
  auction_type             String
  title                    String
  description              String?
  minimum_bid              Decimal
  bid_increment            Decimal
  deposit_percentage       Decimal
  start_time               DateTime
  end_time                 DateTime
  status                   AuctionStatus @default(DRAFT)
  platform_commission_pct  Decimal
  moderator_commission_pct Decimal
  created_at               DateTime      @default(now())

  Seller             User                  @relation("SellerAuctions", fields: [seller_id], references: [user_id])
  AuctionMedia       AuctionMedia[]
  WalletTransactions WalletTransaction[]
  AuctionModerators  AuctionModerator[]
  ModeratorActions   ModeratorAction[]
  AuctionRoom        AuctionRoom?
  Bids               Bid[]
  LetterBidCommits   LetterBidCommit[]
  AutoBidRules       AutoBidRule[]
  AuctionResult      AuctionResult?
  AuctionDeposits    AuctionDeposit[]
  FallbackOffers     FallbackOffer[]
  FraudFlags         FraudFlag[]
  Disputes           Dispute[]
  Notifications      Notification[]
  StateHistory       AuctionStateHistory[]
  AuctionConnections AuctionConnection[]
}

model AuctionMedia {
  media_id   String @id @default(uuid())
  auction_id String
  media_url  String
  media_type String

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
}

// MODERATION
model AuctionModerator {
  auction_moderator_id String  @id @default(uuid())
  auction_id           String
  moderator_id         String
  assigned_by          String
  conflict_checked     Boolean @default(false)
  status               String

  Auction   Auction @relation(fields: [auction_id], references: [auction_id])
  Moderator User    @relation("ModeratorRelation", fields: [moderator_id], references: [user_id])
}

model ModeratorAction {
  action_id    String   @id @default(uuid())
  auction_id   String
  moderator_id String
  action_type  String
  reason       String?
  created_at   DateTime @default(now())

  Auction   Auction @relation(fields: [auction_id], references: [auction_id])
  Moderator User    @relation("ModeratorActions", fields: [moderator_id], references: [user_id])
}

// REAL-TIME BIDDING (LONG & LIVE)
model AuctionRoom {
  room_id             String   @id @default(uuid())
  auction_id          String   @unique
  current_highest_bid Decimal
  last_bid_time       DateTime

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
}

model Bid {
  bid_id     String   @id @default(uuid())
  auction_id String
  user_id    String
  bid_amount Decimal
  bid_source String
  created_at DateTime @default(now())
  is_valid   Boolean  @default(true)

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
  User    User    @relation(fields: [user_id], references: [user_id])
}

// LETTER (SEALED) BID â€“ COMMIT / REVEAL
model LetterBidCommit {
  commit_id    String   @id @default(uuid())
  auction_id   String
  user_id      String
  commit_hash  String
  committed_at DateTime @default(now())

  Auction         Auction          @relation(fields: [auction_id], references: [auction_id])
  User            User             @relation(fields: [user_id], references: [user_id])
  LetterBidReveal LetterBidReveal?
}

model LetterBidReveal {
  reveal_id                 String   @id @default(uuid())
  commit_id                 String   @unique
  revealed_amount           Decimal
  is_verified               Boolean  @default(false)
  revealed_amount_encrypted String
  revealed_at               DateTime @default(now())

  Commit LetterBidCommit @relation(fields: [commit_id], references: [commit_id])
}

// AI & AUTO-BID (PREMIUM)
model SubscriptionPlan {
  plan_id       String  @id @default(uuid())
  name          String
  price         Decimal
  duration_days Int

  UserSubscriptions UserSubscription[]
}

model UserSubscription {
  subscription_id String   @id @default(uuid())
  user_id         String
  plan_id         String
  status          String
  start_date      DateTime
  end_date        DateTime

  User User             @relation(fields: [user_id], references: [user_id])
  Plan SubscriptionPlan @relation(fields: [plan_id], references: [plan_id])
}

model AIAgentProfile {
  ai_agent_id   String  @id @default(uuid())
  user_id       String  @unique
  max_bid_limit Decimal
  risk_level    String
  strategy_type String

  User User @relation(fields: [user_id], references: [user_id])
}

model AutoBidRule {
  auto_bid_id String  @id @default(uuid())
  user_id     String
  auction_id  String
  max_bid     Decimal
  increment   Decimal
  is_active   Boolean @default(true)

  User    User    @relation(fields: [user_id], references: [user_id])
  Auction Auction @relation(fields: [auction_id], references: [auction_id])
}

// AUCTION RESULT & SETTLEMENT
model AuctionResult {
  result_id        String   @id @default(uuid())
  auction_id       String   @unique
  winner_id        String
  winning_bid      Decimal
  status           String
  payment_deadline DateTime
  closed_at        DateTime @default(now())

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
  Winner  User    @relation("WinnerRelation", fields: [winner_id], references: [user_id])
}

model AuctionDeposit {
  deposit_id String  @id @default(uuid())
  auction_id String
  user_id    String
  amount     Decimal
  status     String

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
  User    User    @relation(fields: [user_id], references: [user_id])
}

model FallbackOffer {
  fallback_id    String   @id @default(uuid())
  auction_id     String
  user_id        String
  bid_rank       Int
  offered_amount Decimal
  status         String
  expires_at     DateTime

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
  User    User    @relation(fields: [user_id], references: [user_id])
}

// FRAUD, DISPUTES & SAFETY
model FraudFlag {
  flag_id    String     @id @default(uuid())
  user_id    String
  auction_id String
  reason     String
  risk_score Decimal
  flagged_by FlagSource
  created_at DateTime   @default(now())

  User    User    @relation(fields: [user_id], references: [user_id])
  Auction Auction @relation(fields: [auction_id], references: [auction_id])
}

model Dispute {
  dispute_id      String   @id @default(uuid())
  auction_id      String
  raised_by       String
  description     String
  status          String
  against_user_id String
  created_at      DateTime @default(now())

  Auction     Auction @relation(fields: [auction_id], references: [auction_id])
  Raiser      User    @relation("DisputeRaiser", fields: [raised_by], references: [user_id])
  AccusedUser User    @relation("DisputeAccused", fields: [against_user_id], references: [user_id])
}

// NOTIFICATIONS & EVENTS
model Notification {
  notification_id String   @id @default(uuid())
  user_id         String
  auction_id      String?
  message         String
  is_read         Boolean  @default(false)
  created_at      DateTime @default(now())

  User    User     @relation(fields: [user_id], references: [user_id])
  Auction Auction? @relation(fields: [auction_id], references: [auction_id])
}

// ADMIN & AUDIT
model AdminAction {
  admin_action_id String   @id @default(uuid())
  admin_id        String
  action_type     String
  target_id       String
  reason          String?
  created_at      DateTime @default(now())

  Admin User @relation("AdminRelation", fields: [admin_id], references: [user_id])
}

model SystemAuditLog {
  log_id      String   @id @default(uuid())
  actor_id    String
  action      String
  entity_type String
  entity_id   String
  timestamp   DateTime @default(now())

  Actor User @relation(fields: [actor_id], references: [user_id])
}

model AuctionStateHistory {
  history_id      String   @id @default(uuid())
  auction_id      String
  previous_status String
  new_status      String
  changed_by      String
  reason          String?
  changed_at      DateTime @default(now())

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
}

model AuctionConnection {
  connection_id   String    @id @default(uuid())
  auction_id      String
  user_id         String
  connected_at    DateTime  @default(now())
  disconnected_at DateTime?

  Auction Auction @relation(fields: [auction_id], references: [auction_id])
  User    User    @relation(fields: [user_id], references: [user_id])
}
